---
// src/components/MusicPlayer.astro
// Astro 公共音乐播放器组件：client:load 保证切页常驻
---
<!-- 播放器专属样式：抽离出来，引入组件自动生效 -->
<style is:global>
  .music-play-area {
    position: fixed;
    left: 30px;
    bottom: 30px;
    z-index: 999;
    display: flex;
    gap: 8px;
    align-items: center;
    background: #fff;
    padding: 4px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  .music-btn {
    width: 28px;
    height: 28px;
    background: #4299e1;
    color: #fff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    margin: 0;
    transition: all 0.2s ease;
  }
  .music-btn:hover {
    background: #3182ce;
    box-shadow: 0 2px 6px rgba(66, 153, 225, 0.3);
  }
  .music-btn:active {
    transform: scale(0.95);
  }
  .music-play-pause {
    width: 30px;
    height: 30px;
    font-size: 15px;
  }
  #musicPlayer {
    border-radius: 4px;
    outline: none;
    border: 1px solid #e2e8f0;
  }
  /* 移动端适配 */
  @media (max-width: 768px) {
    .music-play-area {
      left: 20px;
      bottom: 20px;
      gap: 6px;
    }
    .music-btn {
      width: 26px;
      height: 26px;
      font-size: 13px;
    }
    .music-play-pause {
      width: 28px;
      height: 28px;
    }
  }
</style>

<!-- 播放器DOM：client:load 保证容器常驻 -->
<div class="music-play-area" client:load>
  <audio 
    id="musicPlayer" 
    controls 
    preload="auto"
    style="border: none; outline: none;"
    client:load
  >
    你的浏览器不支持音频播放，请更换Chrome/Edge/Firefox等现代浏览器
  </audio>
  <button class="music-btn" id="prevSongBtn" client:load>←</button>
  <button class="music-btn music-play-pause" id="playPauseBtn" client:load>▶</button>
  <button class="music-btn" id="nextSongBtn" client:load>→</button>
</div>

<!-- 播放器核心脚本：client:load 是关键！保证切页不销毁、状态常驻 -->
<script client:load>
  // 音乐列表：所有页面共用，改这里即可
  const musicList = [
    '/music/song1.mp3', 
    '/music/song2.mp3',
    '/music/song3.mp3',
    '/music/song4.mp3',
    '/music/song5.mp3',
    '/music/song6.mp3'
  ];
  const STORAGE_KEY = 'BLOG_MUSIC_STATE';

  // 本地存储工具方法
  function getMusicState() {
    const saved = localStorage.getItem(STORAGE_KEY);
    return saved ? JSON.parse(saved) : { currentIndex: 0, currentTime: 0, isPlaying: false };
  }
  function saveMusicState(state) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  // 全局状态：挂载window，避免重复初始化
  if (!window.musicStore) {
    window.musicStore = {
      state: getMusicState(),
      isInited: false
    };
  }
  const { musicStore } = window;
  let musicState = musicStore.state;

  // 获取DOM元素
  const musicPlayer = document.getElementById('musicPlayer');
  const prevBtn = document.getElementById('prevSongBtn');
  const playPauseBtn = document.getElementById('playPauseBtn');
  const nextBtn = document.getElementById('nextSongBtn');

  // 初始化播放器
  function initPlayer() {
    musicPlayer.src = musicList[musicState.currentIndex];
    musicPlayer.currentTime = musicState.currentTime;
    playPauseBtn.innerHTML = musicState.isPlaying ? '❚❚' : '▶';
    // 自动恢复播放
    if (musicState.isPlaying) {
      setTimeout(() => musicPlayer.play().catch(err => {}), 100);
    }
    // 首次交互触发
    document.body.addEventListener('click', () => {
      if (musicState.isPlaying) musicPlayer.play().catch(err => {});
    }, { once: true });
  }

  // 核心控制方法
  function playPrev() {
    musicState.currentIndex = (musicState.currentIndex - 1 + musicList.length) % musicList.length;
    musicState.currentTime = 0;
    musicPlayer.src = musicList[musicState.currentIndex];
    saveMusicState(musicState);
    if (musicState.isPlaying) musicPlayer.play().catch(err => {});
  }
  function togglePlay() {
    if (musicState.isPlaying) {
      musicPlayer.pause();
    } else {
      musicPlayer.play().catch(err => {
        alert('首次播放请再次点击～');
        musicPlayer.play();
      });
    }
  }
  function playNext() {
    musicState.currentIndex = (musicState.currentIndex + 1) % musicList.length;
    musicState.currentTime = 0;
    musicPlayer.src = musicList[musicState.currentIndex];
    saveMusicState(musicState);
    if (musicState.isPlaying) musicPlayer.play().catch(err => {});
  }

  // 实时同步状态
  function syncState() {
    musicState.isPlaying = !musicPlayer.paused;
    musicState.currentTime = musicPlayer.currentTime;
    playPauseBtn.innerHTML = musicState.isPlaying ? '❚❚' : '▶';
    saveMusicState(musicState);
  }

  // 仅首次初始化事件（避免重复绑定）
  if (!musicStore.isInited) {
    initPlayer();
    // 绑定事件
    prevBtn.onclick = playPrev;
    playPauseBtn.onclick = togglePlay;
    nextBtn.onclick = playNext;
    musicPlayer.onended = playNext;
    musicPlayer.onplay = syncState;
    musicPlayer.onpause = syncState;
    setInterval(syncState, 500);
    // 页面卸载保存状态
    window.addEventListener('beforeunload', () => {
      musicState.currentTime = musicPlayer.currentTime;
      musicState.isPlaying = !musicPlayer.paused;
      saveMusicState(musicState);
    });
    musicStore.isInited = true;
  } else {
    // 非首次加载，直接恢复状态
    initPlayer();
  }
</script>